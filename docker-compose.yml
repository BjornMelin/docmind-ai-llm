version: "3.8"

services:
  app:
    build: .
    ports:
      - "8501:8501"
    environment:
      - OLLAMA_BASE_URL=http://host.docker.internal:11434
      - BACKEND=ollama
      - CONTEXT_SIZE=32768
      - QDRANT_URL=http://qdrant:6333
      - LANGFUSE_PUBLIC_KEY=your_public_key
      - LANGFUSE_SECRET_KEY=your_secret_key
      - LANGFUSE_HOST=https://cloud.langfuse.com
    volumes:
      - .:/app
      - ./models:/models
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      qdrant:
        condition: service_healthy
    deploy:
      resources:
        reservations:
          devices:
            - capabilities: [gpu]

  qdrant:
    image: qdrant/qdrant:v1.15.0
    ports:
      - "6333:6333"
    volumes:
      - qdrant_storage:/qdrant/storage
    healthcheck:
      test: ["CMD", "wget", "--spider", "http://localhost:6333"]
      interval: 5s
      timeout: 3s
      retries: 5

volumes:
  qdrant_storage:
