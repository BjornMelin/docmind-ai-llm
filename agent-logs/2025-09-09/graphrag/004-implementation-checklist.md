# 004 — Implementation Checklist (GraphRAG Phase‑2 Polishing)

- [ ] Persistence: Graph store persisted to persist_dir
  - [ ] src/persistence/snapshot.py → graph_store.persist(str(paths.graph_dir))
  - [ ] Unit: round‑trip load via from_persist_dir
- [ ] Chat: Autoload latest non‑stale snapshot
  - [ ] src/pages/01_chat.py → _load_latest_snapshot_into_session()
  - [ ] Policy knob: latest_non_stale | pinned | ignore
  - [ ] Integration: AppTest asserts router present after run
- [ ] Router: Depth policy (default=1, configurable)
  - [ ] src/retrieval/router_factory.py → RetrieverQueryEngine.from_args(retriever=index.as_retriever(path_depth=...))
  - [ ] Unit: asserts path_depth applied
- [ ] Hash normalization
  - [ ] src/persistence/snapshot.py → compute_corpus_hash(paths, base_dir)
  - [ ] Callers pass base_dir=settings.data_dir/"uploads"
  - [ ] Unit: hashing determinism across path orders/OS
- [ ] Manifest versions
  - [ ] versions include app, llama_index, qdrant_client, embed_model
  - [ ] schema_version, persist_format_version added
  - [ ] Unit: manifest fields assertion
- [ ] Router unification & deprecation
  - [ ] Deprecation shim for AdaptiveRouterQueryEngine → router_factory
  - [ ] src/pages/02_documents.py uses router_factory everywhere
  - [ ] Unit: deprecation warns and returns router; Integration: behavior consistent
- [ ] Exports: Relation labels preserved when available
  - [ ] src/retrieval/graph_config.py extracts label from rel_map where present
  - [ ] Unit: label preserved test
- [ ] UX & Health
  - [ ] router_factory bounded health check
  - [ ] export seed cap configurable (default 32)
  - [ ] st.debug replaced with st.caption/logging
- [ ] Specs/Docs:
  - [ ] SPEC‑014: persist_dir, versions, relpaths
  - [ ] SPEC‑006: depth=1 default, sub‑retrievers optional, export schema
  - [ ] ADR‑038: Chat autoload + router unification
  - [ ] gr-suite trackers updated
- [ ] Verification
  - [ ] Lint/format
  - [ ] Unit/integration tests pass
  - [ ] Acceptance criteria satisfied
