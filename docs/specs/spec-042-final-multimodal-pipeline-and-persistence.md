---
spec: SPEC-042
title: Final Multimodal Pipeline + Cognitive Persistence (End-to-End)
version: 1.0.0
date: 2026-01-12
owners: ["ai-arch"]
status: Implemented
related_requirements:
  - FR-003: Canonical nodes with deterministic IDs and pdf_page_image nodes.
  - FR-004: Embed text (BGE-M3) and images (SigLIP).
  - FR-007: Rerank text and visual/page-image nodes.
  - FR-022: Persist Chat history via LangGraph SqliteSaver and ArtifactRef.
  - FR-SEC-IMG-ENC: AES-GCM encryption-at-rest for page images.
related_adrs: ["ADR-058", "ADR-057", "ADR-037", "ADR-009", "ADR-011", "ADR-014", "ADR-047", "ADR-055"]
notes: "Scope: Data schemas + API signatures for the shipped multimodal pipeline and persistence wiring. ADR-058 is the primary integration source of truth."
---


## 1) Non-negotiable invariants

1. **No base64 blobs in durable stores.**  
   - Qdrant payloads must remain thin (ids + metadata + artifact refs).
   - SQLite chat persistence and memory store must not store image bytes.
2. **No raw filesystem paths as durable identifiers.**  
   - Durable references for multimodal artifacts use `ArtifactRef(sha256, suffix)`.
   - **Forbidden:** absolute paths, user-supplied paths, and host-specific paths (e.g., `/home/...`, `C:\\...`) in Qdrant payloads, LangGraph checkpoints, DocMind store tables, or telemetry JSONL.
   - **Allowed (controlled):** snapshot-internal member paths in `manifest.jsonl` that are generated by SnapshotManager to locate files inside the snapshot directory (these are not stable identifiers outside the snapshot boundary).
3. **Fail-open behavior.**  
   Optional features (SigLIP, sqlite-vec, ColPali) degrade gracefully without breaking core chat.

## 2) Artifact store

### 2.1 ArtifactRef schema

```python
ArtifactRef:
  sha256: str  # 64 hex chars
  suffix: str  # "", ".webp", ".jpg", ".webp.enc", ...
```

### 2.2 Storage layout

- Default root: `settings.data_dir / "artifacts"`
- File naming: `{sha256}{suffix}`
- Directory jail: resolved paths must remain under the root directory.

### 2.3 GC contract

- `ArtifactStore.prune(max_total_bytes, min_age_seconds)` deletes oldest artifacts until under budget.
- GC is best-effort and must not crash ingestion or chat.

## 3) Qdrant image collection

### 3.1 Collection name

- `settings.database.qdrant_image_collection` (string)

### 3.2 Vectors

- Named vector: `siglip`
  - Size: 768 (from `google/siglip-base-patch16-224` via `transformers>=4.55.0,<4.58.0`)
  - Distance: cosine

### 3.3 Payload schema (thin)

Required:

- `doc_id: str`
- `page_no: int`
- `page_id: str` (stable, e.g. `{doc_id}::page::{page_no}`)
- `modality: "pdf_page_image"`
- `image_artifact_id: str` (sha256 hex)
- `image_artifact_suffix: str`
- `thumbnail_artifact_id: str | null`
- `thumbnail_artifact_suffix: str | null`

Optional:

- `phash: str | null`
- `bbox: list[float] | null`
  - If present, must be exactly 4 floats: `[x, y, width, height]`.
  - Units: pixels (top-left origin).
  - Example: `[100.0, 200.0, 50.0, 30.0]` (x=100, y=200, w=50, h=30).
  - Out-of-bounds/negative values should be clamped or ignored by consumers, not crash.
- `text: str | null` (best-effort page text for grounding)

Forbidden:

- `thumbnail_base64`
- `image_base64`
- absolute or user-supplied filesystem paths

## 4) Ingestion contracts

### 4.1 ExportArtifact metadata for page images

Every rendered PDF page image export must include:

- `metadata.modality == "pdf_page_image"`
- `metadata.doc_id`
- `metadata.page_no`
- `metadata.image_artifact_id`, `metadata.image_artifact_suffix`
- optional thumbnail artifact fields

### 4.2 Indexing behavior

- Image indexing is best-effort; ingestion returns success even if image indexing fails.
- Indexing must store only artifact refs in Qdrant payload.

## 5) Retrieval contracts

### 5.1 Multimodal fusion tool

- Router tool name: `multimodal_search`
- Behavior:
  - Retrieve text hybrid results and SigLIP image results.
  - Fuse via RRF and deduplicate by `settings.retrieval.dedup_key` (default: `page_id`).
  - Apply existing reranking postprocessors (SigLIP/optional ColPali) after fusion.

### 5.2 Source sanitization (agent-visible)

Before returning sources into agent-visible JSON, drop runtime-only path fields:

- `image_path`
- `thumbnail_path`
- `source_path`

Artifact IDs/suffixes are allowed and required.

### 5.3 Contextual recall

If a user query is clearly contextual (e.g., “that chart”), and retrieval returns no results, tools may reuse the most recent persisted `documents` from:

- `state["synthesis_result"]["documents"]`, else
- most recent `state["retrieval_results"][*]["documents"]`

This must not persist new blobs; it only reuses structured refs.

## 6) UI requirements (Streamlit)

### 6.1 Chat page

- Must support:
  - session selection + management
  - time travel (checkpoint resume)
  - memory review UI
  - “Sources” expander including image thumbnails
  - query-by-image “Visual search” sidebar (SigLIP image→image)
- Must not use `unsafe_allow_html=True` for user-provided content.

### 6.2 Documents page

- Must:
  - ingest documents
  - show a preview of rendered page images when available
  - always expose snapshot rebuild utilities when indices exist in session_state

## 7) SQLite persistence schemas

### 7.1 chat_session

Owned by DocMind:

```sql
CREATE TABLE chat_session (
  thread_id TEXT PRIMARY KEY,
  title TEXT NOT NULL,
  created_at_ms INTEGER NOT NULL,
  updated_at_ms INTEGER NOT NULL,
  last_checkpoint_id TEXT,
  deleted_at_ms INTEGER
);
```

### 7.2 LangGraph tables

Owned by LangGraph checkpointer (`langgraph-checkpoint-sqlite`):

- `checkpoints`
- `writes`

DocMind code must treat their schema as external and only use them via LangGraph APIs, except for purge (hard delete) operations.

### 7.3 DocMind store tables

Owned by DocMind store adapter:

- `docmind_store_items`
- `docmind_store_vec` (optional, sqlite-vec vec0)

## 8) Test plan (required quality gates)

```bash
uv run ruff format .
uv run ruff check . --fix
uv run pyright
uv run python scripts/run_tests.py --fast
```
