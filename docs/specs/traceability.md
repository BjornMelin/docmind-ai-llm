# Requirements Traceability Matrix (RTM)

| ID | Title | Source | ADR(s) | Code file(s) | Test(s) | Verification | Status |
| --- | --- | --- | --- | --- | --- | --- | --- |
| FR-001 | Unstructured ingest auto+OCR | ADR-002 | 002 | src/processing/ingestion_pipeline.py; src/processing/pdf_pages.py; src/models/processing.py | tests/unit/processing/test_ingestion_pipeline.py; tests/unit/processing/test_pdf_pages_helpers.py; tests/integration/imaging/test_pdf_images_encrypt.py | test | Implemented |
| FR-002 | LlamaIndex pipeline cache | ADR-010 | 010 | src/processing/ingestion_pipeline.py; src/models/processing.py | tests/unit/processing/test_ingestion_pipeline.py; tests/unit/cache/test_ingestion_cache.py | test+analysis | Implemented |
| FR-003 | Deterministic IDs + pdf_page_image | ADR-002 | 002 | src/processing/ingestion_pipeline.py; src/processing/pdf_pages.py; src/models/processing.py | tests/unit/processing/test_ingestion_pipeline.py; tests/unit/processing/test_pdf_pages_helpers.py | test | Implemented |
| FR-004 | BGE‑M3 + SigLIP default (OpenCLIP optional) | ADR‑002 | 002 | src/models/embeddings.py; src/utils/core.py; src/utils/vision_siglip.py; src/utils/images.py | tests/unit/retrieval/embeddings/test_embeddings_refactored.py; tests/unit/models/embeddings/test_bge_m3_text_embedder.py; tests/unit/models/embeddings/test_image_embedder.py; tests/integration/test_unified_embeddings_in_retrieval_integration.py | test | Completed |
| FR-005 | Qdrant server‑side hybrid (RRF default; DBSF env‑gated) | ADR‑005/006 | 005,006 | src/retrieval/hybrid.py; src/utils/storage.py | tests/unit/retrieval/dedup/test_dedup_before_final_cut_unique_key.py; tests/unit/retrieval/test_router_factory_hybrid.py; tests/unit/retrieval/test_qdrant_prefetch_rrf.py; tests/unit/retrieval/test_qdrant_prefetch_dbsf.py; tests/unit/retrieval/test_qdrant_dedup_before_limit.py; tests/unit/telemetry/test_hybrid_retriever_telemetry.py | test | Completed |
| FR-007 | BGE text rerank + SigLIP visual default (optional ColPali) | ADR‑037 | 037 | src/retrieval/reranking.py | tests/unit/rerank/test_rerank_timeout_failopen.py; tests/unit/rerank/test_siglip_rescore_mock.py; tests/unit/rerank/test_rerank_ordering_change.py | test | Completed |
| FR-008 | Always-on hybrid + reranking (no UI toggles; env overrides only) | ADR‑024/036 | 024,036 | src/config/settings.py (maps `DOCMIND_RETRIEVAL__USE_RERANKING`), src/retrieval/hybrid.py, src/retrieval/reranking.py | tests/integration/test_settings_page.py | inspection | Implemented |
| FR-017 | Minimal telemetry (latency, fusion mode, reranker hits) | ADR‑032 | 032 | src/telemetry/opentelemetry.py; src/utils/telemetry.py; src/retrieval/reranking.py; src/pages/01_chat.py | tests/unit/telemetry/test_observability_config.py; tests/unit/telemetry/test_otel_setup.py; tests/unit/telemetry/test_telemetry_schema_assertions.py | test | Implemented |
| FR-018 | Telemetry rotation & sampling toggles | ADR‑032 | 032 | src/telemetry/opentelemetry.py; src/utils/telemetry.py | tests/unit/telemetry/test_observability_config.py; tests/unit/telemetry/test_rotation_sampling.py | test | Implemented |
| FR-019 | Configurable dedup key (page_id/doc_id) | ADR‑005/006 | 005,006 | src/retrieval/hybrid.py; src/config/settings.py | tests/unit/retrieval/qdrant/test_qdrant_dedup_docid.py; tests/unit/retrieval/qdrant/test_qdrant_dedup_before_limit.py | test | Completed |
| FR‑SEC‑IMG‑ENC | AES‑GCM encryption‑at‑rest for page images | ADR‑024 | 011,024 | src/utils/security.py; src/processing/pdf_pages.py | tests/unit/utils/security/test_encrypt_file.py; tests/integration/imaging/test_pdf_images_encrypt.py | test | Completed |
| FR-009 | GraphRAG PropertyGraphIndex | ADR-019, ADR-038 | 019, 038 | src/retrieval/graph_config.py; src/retrieval/router_factory.py; src/persistence/snapshot.py; src/persistence/snapshot_service.py; src/persistence/lockfile.py; src/pages/01_chat.py; src/pages/02_documents.py | tests/unit/retrieval/test_graph_seed_policy.py; tests/unit/persistence/test_snapshot_manager.py; tests/unit/persistence/test_snapshot_lock.py; tests/unit/persistence/test_snapshot_roundtrip.py; tests/unit/ui/test_documents_snapshot_utils.py; tests/integration/ui/test_documents_snapshot_button.py | test | Implemented |
| FR-009.1 | Staleness badge (Chat; local-only; exact tooltip) | SPEC-014 | 014 | src/pages/01_chat.py | tests/unit/pages/test_chat_staleness.py; tests/unit/ui/test_chat_staleness_badge.py; tests/unit/pages/test_chat_tooltip_copy.py | test | Implemented |
| FR-009.2 | SnapshotManager lock + atomic rename + tri-file manifest (`complete` flag, checksum) | SPEC-014 | 014 | src/persistence/snapshot.py; src/persistence/lockfile.py | tests/unit/persistence/test_snapshot_manager.py; tests/unit/persistence/test_snapshot_lock.py; tests/unit/persistence/test_snapshot_roundtrip.py | test | Implemented |
| FR-009.3 | Exports: JSONL required; Parquet optional; timestamped filenames + telemetry | SPEC-006 | 006 | src/retrieval/graph_config.py; src/pages/02_documents.py | tests/unit/retrieval/test_graph_seed_policy.py; tests/unit/ui/test_documents_snapshot_utils.py; tests/integration/ui/test_documents_snapshot_button.py | test | Implemented |
| FR-009.4 | Export seeds deterministic, deduped, cap=32 | SPEC-006 | 006 | src/retrieval/graph_config.py | tests/unit/retrieval/test_graph_seed_policy.py | test | Implemented |
| FR-009.5 | Export path security (non-egress; sanitize; symlink block) | SPEC-011 | 011 | src/utils/security.py | tests/unit/security/test_export_path_validation.py; tests/unit/utils/test_security.py | test | Implemented |
| FR-009.6 | Telemetry events: router_selected, snapshot_stale_detected, export_performed, traversal_depth | SPEC-012 | 012 | src/telemetry/opentelemetry.py; src/utils/telemetry.py; src/agents/tools/router_tool.py; src/pages/01_chat.py; src/pages/02_documents.py | tests/unit/telemetry/test_observability_config.py; tests/unit/telemetry/test_telemetry_schema_assertions.py; tests/unit/agents/test_router_tool_telemetry.py; tests/unit/ui/test_documents_snapshot_utils.py | test | Implemented |
| FR‑SEC‑NET‑001 | Offline-first allowlist; OpenAI-like /v1 normalization; local-only default | SPEC-011; ADR-024 | 011, 024 | src/config/settings.py; src/pages/04_settings.py; src/config/llm_factory.py | tests/integration/test_settings_page.py; tests/unit/config/test_endpoint_allowlist.py; tests/unit/config/test_integrations.py; tests/unit/config/test_integrations_remote_allowlist.py; tests/unit/config/test_integrations_runtime.py; tests/unit/config/test_integrations_runtime_extra.py; tests/unit/config/test_llamacpp_local_path_remote_enforcement.py; tests/unit/config/test_llm_factory.py; tests/unit/config/test_llm_factory_empty_model_defaulting.py; tests/unit/config/test_llm_factory_unsupported.py; tests/unit/config/test_openai_like_env_mapping.py; tests/unit/config/test_retrieval_env_mapping.py; tests/unit/config/test_settings_allowlist.py; tests/unit/config/test_settings_backend_url_and_policies.py; tests/unit/config/test_settings_roundtrip.py | test | Implemented |
| FR-010 | Streamlit multipage | SPEC-008 | 013,016 | src/app.py; src/pages/01_chat.py; src/pages/02_documents.py; src/pages/03_analytics.py; src/pages/04_settings.py | tests/integration/test_pages_smoke.py; tests/integration/test_settings_page.py | inspection | Completed |
| FR-012 | Multi-provider UI | ADR-009 | 009 | src/config/llm_factory.py; src/pages/04_settings.py | tests/unit/config/test_llm_factory.py; tests/unit/config/test_llm_factory_empty_model_defaulting.py; tests/unit/config/test_integrations_runtime.py; tests/integration/test_settings_page.py | test | Completed |
| FR-014 | LangGraph supervisor | ADR-001 | 001 | src/agents/\* | tests_agents/\* | test | In repo |
| FR-015 | Operational metadata via SQLite WAL | SPEC-039 | 055 | src/persistence/ops_db.py; src/config/settings.py | tests/unit/persistence/test_ops_db_migrations.py; tests/unit/persistence/test_ops_db_jobs.py | test | Planned |
| FR-020 | Prompt Template System (RichPromptTemplate, file-based) | ADR‑020 | 020 | src/prompting/\*; templates/prompts/\*; templates/presets/\* | tests/unit/prompting/\*; tests/integration/test_prompt_registry.py; tests/e2e/test_prompt_system.py | test | Completed |
| FR-021 | Settings pre-validation + safe badge | SPEC-022 | 041 | src/pages/04_settings.py; src/ui/components/provider_badge.py; src/config/env_persistence.py | tests/integration/test_settings_page.py; tests/unit/ui/test_provider_badge.py; tests/unit/ui/test_settings_env_persistence.py | test | Implemented |
| FR-022 | Chat persistence (LangGraph SQLite) | SPEC-041; SPEC-042 | 057,058 | src/pages/01_chat.py; src/persistence/chat_db.py; src/ui/chat_sessions.py; src/agents/coordinator.py | tests/integration/ui/test_chat_autoload_snapshot.py; tests/unit/persistence/test_chat_db_sessions.py | test | Implemented |
| FR-030 | Chat sessions (create/rename/delete/select) | SPEC-041; SPEC-042 | 057,058 | src/ui/chat_sessions.py; src/persistence/chat_db.py; src/pages/01_chat.py | tests/unit/persistence/test_chat_db_sessions.py | test | Implemented |
| FR-031 | Chat time travel (fork + resume) | SPEC-041; SPEC-042 | 057,058 | src/pages/01_chat.py; src/agents/coordinator.py; src/ui/chat_sessions.py | tests/integration/ui/test_chat_autoload_snapshot.py (UI smoke) | test | Implemented (smoke) |
| FR-032 | Long-term memory (store/search/review/purge) | SPEC-041; SPEC-042 | 057,058 | src/agents/tools/memory.py; src/agents/registry/tool_registry.py; src/persistence/memory_store.py; src/pages/01_chat.py | tests/unit/persistence/test_memory_store_basic.py | test | Implemented |
| FR-033 | ArtifactStore (content-addressed binary refs) | SPEC-042 | 058 | src/persistence/artifacts.py; src/processing/ingestion_pipeline.py; src/pages/01_chat.py | tests/unit/persistence/test_artifact_store.py | test | Implemented |
| FR-034 | Multimodal retrieval (text+image fusion) | SPEC-042 | 058 | src/retrieval/multimodal_fusion.py; src/retrieval/router_factory.py; src/agents/tools/retrieval.py | tests/unit/retrieval/test_router_factory_injection_toggle.py; tests/unit/retrieval/test_router_factory_kg_health_gate.py | test | Implemented |
| FR-035 | Query-by-image (SigLIP visual search UI) | SPEC-042 | 058 | src/pages/01_chat.py | tests/integration/ui/test_chat_autoload_snapshot.py (UI smoke) | test | Implemented (smoke) |
| FR-023 | Keyword tool (sparse-only Qdrant) | SPEC-025 | 044 | src/retrieval/keyword.py; src/agents/tool_factory.py | tests/unit/agents/test_tool_factory_keyword.py; tests/unit/retrieval/test_keyword_retriever.py | test | Implemented |
| FR-024 | Programmatic ingestion API + legacy facade | SPEC-026 | 045 | src/processing/ingestion_api.py; src/utils/document.py; src/processing/**init**.py | tests/unit/processing/_; tests/unit/utils/document/_ | test | Planned |
| FR-025 | Background ingestion jobs (progress + cancel) | SPEC-033 | 052 | src/ui/background_jobs.py; src/pages/02_documents.py | tests/unit/ui/test_background_jobs.py; tests/integration/ui/test_documents_ingestion_job.py | test | Planned |
| FR-026 | Semantic response cache (Qdrant-backed, guardrailed) | SPEC-038 | 035 | src/utils/semantic_cache.py; src/agents/coordinator.py; src/config/settings.py | tests/unit/utils/test_semantic_cache.py; tests/integration/test_semantic_cache_integration.py | test | Planned |
| FR-027 | Local backup & retention (snapshots + cache + optional uploads/analytics) | SPEC-037 | 033 | scripts/backup.py; src/utils/security.py | tests/unit/scripts/test_backup_rotation.py; tests/unit/scripts/test_backup_manifest.py | test | Planned |
| FR-028 | Document analysis modes (auto/separate/combined) | SPEC-036 | 023 | src/analysis/service.py; src/analysis/models.py; src/pages/01_chat.py | tests/unit/analysis/test_analysis_service.py; tests/integration/ui/test_analysis_modes.py | test | Planned |
| FR-029 | Agent deadline propagation + router injection | SPEC-040 | 056 | src/agents/coordinator.py; src/agents/models.py; src/agents/registry/tool_registry.py; src/agents/tools/retrieval.py; src/config/langchain_factory.py; src/config/llm_factory.py | tests/unit/agents/test_deadline_seeded.py; tests/unit/agents/test_tool_registry_retrieval_tool.py; tests/unit/agents/test_router_injection_path.py; tests/unit/config/test_timeout_caps.py | test | Planned |
| NFR-PORT-003 | Docker/compose runnable + reproducible | SPEC-023 | 042 | Dockerfile; docker-compose.yml; docker-compose.prod.yml; .dockerignore | N/A | inspection/manual run | Implemented |
| NFR-SEC-002 | Safe logging (metadata only; keyed fingerprints; no stub redactor) | SPEC-028 | 047 | src/utils/security.py; src/utils/log_safety.py | tests/unit/utils/security/test_security.py | test | Planned |
| NFR-SEC-004 | No unsafe HTML/JS in Streamlit UI | SPEC-022 | 041 | src/ui/components/provider_badge.py | tests/unit/ui/test_provider_badge.py; tests/integration/test_settings_page.py | test+inspection | Implemented |
| NFR-MAINT-003 | No placeholders; docs/specs/RTM match code | SPEC-021; SPEC-029 | 046,048 | docs/specs/_; docs/developers/_; scripts/\* | scripts/\* (health/drift checks) | quality gates | Planned |
| NFR-MAINT-003.1 | Remove unused multimodal helper | SPEC-030 | 049 | src/utils/multimodal.py (deleted); src/utils/__init__.py; docs/developers/system-architecture.md; docs/specs/prompts/completed/spec-003-embeddings.prompt.md | N/A (tests deleted) | inspection+quality gates | Implemented |
